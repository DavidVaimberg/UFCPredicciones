<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial de Predicciones</title>

  <nav>
    <a href="index.html">üè† Inicio</a>
    <a href="stats.html">üìä Estad√≠sticas</a>
    <a href="perfil.html">üë§ Mi Perfil</a>
  </nav>

 <style>
        @import url('https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap');
        
        body { 
            font-family: 'Roboto', sans-serif;
            background: #1a1a1a;
            color: #f2f2f2;
            padding: 20px; 
            margin: 0;
        }

        /* --- Estilos de Navegaci√≥n COMPLETOS --- */
        nav {
            background: #111; 
            padding: 15px 5px; 
            text-align: center;
            border-bottom: 2px solid #DAA520; 
            display: flex;
            justify-content: center; 
            align-items: center;
            margin: -20px -20px 20px -20px; /* Ajuste para que ocupe todo el ancho */
        }
        nav a {
            font-family: 'Anton', sans-serif; 
            color: white; 
            margin: 0 15px;
            text-decoration: none; 
            font-size: 1.2em; 
            letter-spacing: 1px;
            transition: color 0.3s; 
            flex-shrink: 0; 
        }
        nav a:hover { 
            color: #DAA520; 
        }
        @media (max-width: 700px) {
            nav { 
                justify-content: space-around; 
            }
            nav a {
                font-size: 1em; 
                margin: 0 5px; 
                letter-spacing: normal; 
            }
        }
        /* --- Fin de Estilos de Navegaci√≥n --- */

        h1, h2 { 
            text-align: center;
            font-family: 'Anton', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #DAA520;
        }
        h1 { font-size: 3.75em; } 
        h2 { font-size: 1.8em; text-align: center; }

        .content { 
            max-width: 1000px; 
            margin: auto; 
            background: #2b2b2b;
            padding: 20px; 
            border-radius: 10px;
            border-top: 4px solid #DAA520;
        }
        
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }

        select { 
            font-size: 16px; 
            padding: 10px; 
            margin-bottom: 20px; 
            width: 100%;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            box-sizing: border-box; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
            table-layout: fixed;
        }
        th, td { 
            border: 1px solid #444;
            padding: 8px; 
            text-align: center; 
            word-wrap: break-word;
            color: #f2f2f2; 
        }
        th { 
            background-color: #1f1f1f;
            color: #DAA520;
            font-family: 'Anton', sans-serif;
            letter-spacing: 1px;
        }
        .acierto { 
            background-color: rgba(40, 167, 69, 0.2); 
        }
        .fallo { 
            background-color: rgba(220, 53, 69, 0.2); 
        }
        tbody tr:hover { 
            background-color: #3c3c3c; 
        }
        .user-block { 
            margin-bottom: 30px; 
        }
        #historial-container { 
            text-align: center; 
        }
        
        /* Estilo para el loader */
        .loader {
            border: 6px solid #555;
            border-top: 6px solid #DAA520;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="content">
    <h1>Historial de Predicciones</h1>

    <label for="season-select">Selecciona Temporada:</label>
    <select id="season-select">
        <option value="2026" selected>2026 (Liga Actual)</option>
        <option value="2025">2025 (Hist√≥rico)</option>
    </select>

    <label for="evento-select">Selecciona un evento para ver el historial:</label>
    <select id="evento-select"></select>

    <div id="historial-container"><p>Selecciona un evento para empezar.</p></div>
  </div>

<script>
    const SUPABASE_URL = 'https://dvpckpkgiwicifweiupo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2cGNrcGtnaXdpY2lmd2VpdXBvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzAzMzgsImV4cCI6MjA3MDA0NjMzOH0.37X7ZZ9cNDUlplHSSGrypxhmAKXpHUyFdrq9nJOdhbw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentSeason = 2026; // Temporada por defecto

    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
            window.location.href = 'index.html';
            return;
        }
        
        // Listener para cambio de temporada
        const seasonSelect = document.getElementById('season-select');
        seasonSelect.addEventListener('change', async (e) => {
            currentSeason = parseInt(e.target.value);
            // Limpiamos el contenedor y recargamos eventos
            document.getElementById("historial-container").innerHTML = '<p>Selecciona un evento para empezar.</p>';
            await cargarEventos();
        });

        await cargarEventos();
        
        const selector = document.getElementById("evento-select");
        selector.addEventListener("change", mostrarHistorial);
    });

    async function cargarEventos() {
        const selector = document.getElementById("evento-select");
        selector.innerHTML = '<option value="">Cargando eventos...</option>';
        
        // Traemos tambi√©n la columna 'temporada'
        const { data: eventos, error } = await supabaseClient.from('eventos').select('id, nombre, temporada').order('id', { ascending: false });

        if (error) {
            selector.innerHTML = '<option value="">Error al cargar eventos</option>';
            return console.error(error);
        }

        // Filtramos por la temporada seleccionada
        const eventosFiltrados = eventos.filter(e => {
            if (currentSeason === 2025) {
                return e.temporada === 2025 || e.temporada === null;
            } else {
                return e.temporada === currentSeason;
            }
        });

        selector.innerHTML = '<option value="">-- Selecciona un evento --</option>';
        
        if (eventosFiltrados.length === 0) {
            selector.innerHTML += '<option disabled>No hay eventos en esta temporada</option>';
        } else {
            eventosFiltrados.forEach(evento => {
                selector.innerHTML += `<option value="${evento.id}">${evento.nombre}</option>`;
            });
        }
    }

    async function mostrarHistorial() {
        const eventoId = document.getElementById("evento-select").value;
        const container = document.getElementById("historial-container");

        if (!eventoId) {
            container.innerHTML = '<p>Selecciona un evento para empezar.</p>';
            return;
        }

        container.innerHTML = '<div class="loader"></div><p>Cargando historial...</p>'; 

        const { data: peleas, error: peleasError } = await supabaseClient.from('peleas').select('id').eq('evento_id', eventoId);
        if (peleasError || !peleas || peleas.length === 0) {
            container.innerHTML = '<p>No se encontraron peleas para este evento.</p>';
            return console.error("Error o no hay peleas:", peleasError);
        }
        const peleaIDs = peleas.map(p => p.id);

        const { data: predicciones, error: predError } = await supabaseClient.from('predicciones').select(`*, peleas(nombre), profiles(username)`).in('pelea_id', peleaIDs);
        const { data: resultados, error: resError } = await supabaseClient.from('resultados').select(`*, peleas(nombre)`).in('pelea_id', peleaIDs);

        if (predError || resError) {
            container.innerHTML = '<p>Error al cargar el historial.</p>';
            return console.error(predError || resError);
        }

        const prediccionesPorUsuario = {};
        for (const pred of predicciones) {
            const userId = pred.usuario_id;
            const username = pred.profiles ? pred.profiles.username : 'Usuario Desconocido';
            if (!prediccionesPorUsuario[userId]) {
                prediccionesPorUsuario[userId] = { username: username, predicciones: [] };
            }
            prediccionesPorUsuario[userId].predicciones.push(pred);
        }

        let html = '';
        for (const userId in prediccionesPorUsuario) {
            const userData = prediccionesPorUsuario[userId];
            html += `<div class="user-block">
                        <h2>${userData.username}</h2>
                        <table>
                            <thead>
                                <tr><th>Pelea</th><th>Ganador Elegido</th><th>M√©todo</th><th>Round</th><th>Ganador Real</th><th>Resultado Real</th><th>‚úîÔ∏è</th></tr>
                            </thead>
                            <tbody>`;
            
            // --- INICIO DE LA L√ìGICA CORREGIDA PARA MOSTRAR RESULTADOS ---
            userData.predicciones.sort((a,b) => a.pelea_id - b.pelea_id).forEach(p => {
                const res = resultados.find(r => r.pelea_id === p.pelea_id);
                const acierto = res && res.ganador_real === p.ganador_elegido;
                let resultadoTexto = 'N/A';
                let ganadorRealTexto = 'N/A';

                if (res) {
                    ganadorRealTexto = res.ganador_real; 
                    if (res.ganador_real === 'Draw') {
                        resultadoTexto = 'Empate';
                        ganadorRealTexto = 'Empate';
                    } else if (res.ganador_real === 'NC') {
                        resultadoTexto = 'No Contest';
                        ganadorRealTexto = 'NC';
                    } else {
                        resultadoTexto = (res.metodo_real || '') + (res.round_real ? ' R' + res.round_real : '');
                        if (!resultadoTexto.trim()) resultadoTexto = 'N/A';
                    }
                }

                html += `<tr class="${acierto ? 'acierto' : 'fallo'}">
                            <td>${p.peleas ? p.peleas.nombre : 'Pelea Desconocida'}</td>
                            <td>${p.ganador_elegido}</td>
                            <td>${p.metodo_elegido || '-'}</td>
                            <td>${p.round_elegido || '-'}</td>
                            <td>${ganadorRealTexto}</td> <td>${resultadoTexto}</td> <td>${acierto ? '‚úÖ' : '‚ùå'}</td>
                         </tr>`;
            });
            // --- FIN DE LA L√ìGICA CORREGIDA ---

            html += `</tbody></table></div>`;
        }

        container.innerHTML = html || '<p>No hay predicciones registradas para este evento.</p>';
    }
</script>

</body>
</html>
