<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Predicciones UFC</title>
  
  <nav style="background:#111; padding:10px; text-align:center;">
    <a href="stats.html" style="color:white; margin:0 15px;">üìä Estad√≠sticas</a>
    <a href="historial.html" style="color:white; margin:0 15px;">üìÅ Historial</a>
    <a href="perfil.html" style="color:white; margin:0 15px;">üë§ Mi Perfil</a>
  </nav>

  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 20px; }
    h1, h2 { text-align: center; }
    .fight, .login-box, .panel-box, .admin-box, .ranking-box { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
    label { display: block; margin-top: 10px; }
    .section { max-width: 800px; margin: auto; }
    .submit-btn { display: block; margin: 20px auto; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    .method, .round { margin-top: 10px; }
    .hidden { display: none; }
    input[type="text"], input[type="email"], input[type="password"], input[type="number"], select { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px; box-sizing: border-box; }
    button { padding: 10px 15px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #eee; }
    .acierto { background-color: #d4edda; }
    .fallo { background-color: #f8d7da; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Predicciones UFC</h1>

  <div class="section" id="auth-section">
    <div class="login-box">
      <div id="login-form">
        <h2>Iniciar sesi√≥n</h2>
        <label for="login-email">Email:</label>
        <input type="email" id="login-email" placeholder="tu@email.com">
        <label for="login-password">Contrase√±a:</label>
        <input type="password" id="login-password">
        <label for="event-selector">Selecciona evento:</label>
        <select id="event-selector"></select>
        <button onclick="login()">Entrar</button>
        <p>¬øNo tienes cuenta? <a href="#" onclick="toggleAuthForms()">Reg√≠strate</a></p>
      </div>
      <div id="register-form" class="hidden">
        <h2>Crear cuenta</h2>
        <label for="register-username">Nombre de usuario (corto, sin espacios):</label>
        <input type="text" id="register-username" placeholder="ej: david">
        <label for="register-email">Email:</label>
        <input type="email" id="register-email" placeholder="tu@email.com">
        <label for="register-password">Contrase√±a:</label>
        <input type="password" id="register-password">
        <button onclick="register()">Registrarme</button>
        <p>¬øYa tienes cuenta? <a href="#" onclick="toggleAuthForms()">Inicia sesi√≥n</a></p>
      </div>
    </div>
  </div>

  <div class="section hidden" id="prediction-section">
    <h2 id="welcome-user"></h2>
    <div id="fight-list"></div>
    <button class="submit-btn" id="submit-btn" onclick="submitPredictions()">Enviar Predicciones</button>
    <button class="submit-btn" onclick="logout()" style="background-color:#d9534f; color:white;">Cerrar Sesi√≥n</button>
  </div>

  <div class="section hidden" id="admin-section">
    <div class="admin-box">
      <h2>Panel Administrador - Confirmar Resultados</h2>
      <div id="admin-fight-list"></div>
      <button class="submit-btn" onclick="saveResults()">Guardar Resultados</button>
      
      <button class="submit-btn" onclick="procesarLogros()" style="background-color:#5bc0de; margin-top:5px;">
        üèÜ Calcular Puntos y Repartir Logros
      </button>

    </div>
  
<script>
  const SUPABASE_URL = 'https://dvpckpkgiwicifweiupo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2cGNrcGtnaXdpY2lmd2VpdXBvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzAzMzgsImV4cCI6MjA3MDA0NjMzOH0.37X7ZZ9cNDUlplHSSGrypxhmAKXpHUyFdrq9nJOdhbw';
  
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Email del admin configurado.
  const ADMIN_EMAIL = "djvaimbergp@gmail.com"; 

  let currentUser = null;
  let currentEvent = null;
  let peleasDelEvento = []; // Cach√© de peleas para no pedirlas de nuevo

  document.addEventListener('DOMContentLoaded', async () => {
    await loadActiveEvents();
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
        currentUser = session.user;
        const eventSelector = document.getElementById('event-selector');
        if (eventSelector.value && eventSelector.value !== "No hay eventos activos") {
            await showPredictionScreen();
        }
    }
  });

  function toggleAuthForms() {
    document.getElementById('login-form').classList.toggle('hidden');
    document.getElementById('register-form').classList.toggle('hidden');
  }

  async function loadActiveEvents() {
    const selector = document.getElementById('event-selector');
    selector.innerHTML = '<option>Cargando eventos...</option>';
    const { data: eventos, error } = await supabaseClient.from('eventos').select('id, nombre').eq('esta_activo', true);
    if (error) {
      console.error('Error cargando eventos:', error);
      selector.innerHTML = '<option>Error al cargar</option>';
      return;
    }
    selector.innerHTML = '';
    if (eventos.length === 0) {
        selector.innerHTML = '<option>No hay eventos activos</option>';
    } else {
        eventos.forEach(evento => {
            const option = document.createElement('option');
            option.value = evento.id;
            option.textContent = evento.nombre;
            selector.appendChild(option);
        });
    }
  }

  async function register() {
    const username = document.getElementById('register-username').value.trim();
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value.trim();
    if (!username || !email || !password) return alert('Todos los campos son obligatorios.');
    const { data, error } = await supabaseClient.auth.signUp({
      email: email,
      password: password,
      options: { data: { username: username } }
    });
    if (error) return alert('Error al registrar: ' + error.message);
    alert('¬°Registro exitoso! Ya puedes iniciar sesi√≥n.');
    toggleAuthForms();
  }

  async function login() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const { data, error } = await supabaseClient.auth.signInWithPassword({ email: email, password: password });
    if (error) return alert('Error al iniciar sesi√≥n: ' + error.message);
    currentUser = data.user;
    await showPredictionScreen();
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.reload(); // Recarga la p√°gina para volver al estado inicial
  }
  
  async function showPredictionScreen() {
    const eventSelector = document.getElementById('event-selector');
    if (!eventSelector.value || eventSelector.value === "No hay eventos activos") return;
    
    currentEvent = { id: eventSelector.value, name: eventSelector.options[eventSelector.selectedIndex].text };
    
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('prediction-section').classList.remove('hidden');
    document.getElementById('welcome-user').innerText = `Bienvenido, ${currentUser.user_metadata.username || currentUser.email} (${currentEvent.name})`;
    
    if (currentUser.email === ADMIN_EMAIL) {
        document.getElementById('admin-section').classList.remove('hidden');
        renderAdminPanel();
    } else {
        document.getElementById('admin-section').classList.add('hidden');
    }

    const { data: peleas, error: peleasError } = await supabaseClient.from('peleas').select('id').eq('evento_id', currentEvent.id).limit(1);
    if (peleasError || !peleas || peleas.length === 0) {
        document.getElementById('fight-list').innerHTML = "<h2>No se encontraron peleas para este evento.</h2>";
        return;
    }
    
    const { count, error: predictionError } = await supabaseClient.from('predicciones').select('*', { count: 'exact', head: true }).eq('usuario_id', currentUser.id).eq('pelea_id', peleas[0].id);
    if (predictionError) {
        document.getElementById('fight-list').innerHTML = "<h2>Error al verificar tus predicciones.</h2>";
        console.error("Error al contar predicciones:", predictionError);
        return;
    }

    if (count > 0) {
        document.getElementById('fight-list').innerHTML = "<h2>Ya has guardado tus predicciones para este evento. ¬°Mucha suerte!</h2>";
        document.getElementById('submit-btn').classList.add('hidden');
    } else {
        renderFights();
        document.getElementById('submit-btn').classList.remove('hidden');
    }
  }

  async function renderFights() {
    const container = document.getElementById("fight-list");
    container.innerHTML = '<h2>Cargando peleas...</h2>';
    const { data: peleas, error } = await supabaseClient.from('peleas').select('*').eq('evento_id', currentEvent.id).order('id', { ascending: true });
    if (error) {
      console.error('Error cargando peleas:', error);
      container.innerHTML = '<h2>Error al cargar las peleas.</h2>';
      return;
    }
    peleasDelEvento = peleas;
    container.innerHTML = '';
    
    peleas.forEach(f => {
      const div = document.createElement("div");
      div.classList.add("fight");
      div.setAttribute('data-pelea-id', f.id);
      let extraFields = '';
      if (f.tipo === 'Main Card') {
        extraFields += `<div class="method"><label>M√©todo de victoria:</label><select id="method_${f.id}"><option value="">Selecciona...</option><option value="KO">KO/TKO</option><option value="Submisi√≥n">Submisi√≥n</option><option value="Decisi√≥n">Decisi√≥n</option></select></div>`;
      }
      if (f.es_evento_principal) {
        let roundOptions = '<option value="">Selecciona...</option>';
        for (let i = 1; i <= f.numero_de_rounds; i++) {
          roundOptions += `<option value="${i}">Round ${i}</option>`;
        }
        if (f.numero_de_rounds > 3) {
            roundOptions += `<option value="Decision">Decisi√≥n</option>`;
        }
        extraFields += `<div class="round"><label><strong>Round en que termina:</strong></label><select id="round_${f.id}">${roundOptions}</select></div>`;
      }
      div.innerHTML = `<strong>${f.nombre}</strong><br><label><input type="radio" name="fight_${f.id}" value="${f.luchador1}"> ${f.luchador1}</label><label><input type="radio" name="fight_${f.id}" value="${f.luchador2}"> ${f.luchador2}</label>${extraFields}`;
      container.appendChild(div);
    });
  }

  // REEMPLAZA TU FUNCI√ìN 'submitPredictions' CON ESTA
// En tu archivo index.html, reemplaza esta funci√≥n
async function submitPredictions() {
    const predictionsToInsert = [];
    for (const pelea of peleasDelEvento) {
        const ganadorSeleccionado = document.querySelector(`input[name='fight_${pelea.id}']:checked`);
        if (!ganadorSeleccionado) return alert(`Debes elegir un ganador para la pelea: "${pelea.nombre}"`);
        let metodo = null, round = null;
        if (pelea.tipo === 'Main Card') {
            const metodoSelect = document.getElementById(`method_${pelea.id}`);
            if (!metodoSelect.value) return alert(`Debes elegir un m√©todo para la pelea de Main Card: "${pelea.nombre}"`);
            metodo = metodoSelect.value;
        }
        if (pelea.es_evento_principal) {
            const roundSelect = document.getElementById(`round_${pelea.id}`);
            if (!roundSelect.value) return alert(`Debes elegir un round para la pelea principal`);
            round = roundSelect.value;
        }
        predictionsToInsert.push({ usuario_id: currentUser.id, pelea_id: pelea.id, ganador_elegido: ganadorSeleccionado.value, metodo_elegido: metodo, round_elegido: round });
    }

    const { error } = await supabaseClient.from('predicciones').insert(predictionsToInsert);
    if (error) {
        console.error('Error al guardar las predicciones:', error);
        return alert(`Hubo un error al guardar: ${error.message}`);
    }

    alert('¬°Predicciones guardadas con √©xito!');
    document.getElementById('fight-list').innerHTML = "<h2>¬°Gracias! Tus predicciones han sido guardadas. ¬°Mucha suerte!</h2>";
    document.getElementById('submit-btn').classList.add('hidden');

    // --- L√≥gica para el logro "NOVATO VALIENTE" ---
    try {
        const { data: logro } = await supabaseClient.from('logros').select('id').eq('clave_unica', 'NOVATO_VALIENTE').single();
        if (logro) {
            // Esto solo funcionar√° la primera vez gracias a la restricci√≥n UNIQUE de la tabla
            await supabaseClient.from('logros_obtenidos').insert({
                usuario_id: currentUser.id,
                logro_id: logro.id,
                evento_id: currentEvent.id
            });
            console.log('Intento de dar logro "Novato Valiente" completado.');
        }
    } catch (error) {
        console.log('El usuario probablemente ya tiene el logro "Novato Valiente".');
    }
}

  async function renderAdminPanel() {
    const container = document.getElementById("admin-fight-list");
    container.innerHTML = '<h4>Cargando peleas para el panel...</h4>';

    const { data: peleas, error: peleasError } = await supabaseClient.from('peleas').select('*').eq('evento_id', currentEvent.id).order('id', { ascending: true });
    if (peleasError) return console.error("Admin Error (peleas):", peleasError);
    
    peleasDelEvento = peleas; // Actualizamos el cach√© de peleas

    const peleaIDs = peleas.map(p => p.id);
    const { data: resultadosExistentes, error: resError } = await supabaseClient.from('resultados').select('*').in('pelea_id', peleaIDs);
    if (resError) return console.error("Admin Error (resultados):", resError);

    container.innerHTML = '';
    peleas.forEach(f => {
        const resultadoGuardado = resultadosExistentes.find(r => r.pelea_id === f.id) || {};
        let extraFields = '';
        if (f.tipo === 'Main Card') {
            extraFields += `<br><label>M√©todo Real:</label><select id="admin_method_${f.id}"><option value="">Selecciona...</option><option value="KO" ${resultadoGuardado.metodo_real === 'KO' ? 'selected' : ''}>KO/TKO</option><option value="Submisi√≥n" ${resultadoGuardado.metodo_real === 'Submisi√≥n' ? 'selected' : ''}>Submisi√≥n</option><option value="Decisi√≥n" ${resultadoGuardado.metodo_real === 'Decisi√≥n' ? 'selected' : ''}>Decisi√≥n</option></select>`;
        }
        if (f.es_evento_principal) {
            extraFields += `<br><label>Round Real:</label><input type="number" id="admin_round_${f.id}" min="1" max="${f.numero_de_rounds}" value="${resultadoGuardado.round_real || ''}">`;
        }
        container.innerHTML += `<div style="margin-bottom:15px; padding:10px; border:1px solid #ddd;"><strong>${f.nombre}</strong><br><label><input type="radio" name="admin_winner_${f.id}" value="${f.luchador1}" ${resultadoGuardado.ganador_real === f.luchador1 ? 'checked' : ''}/> ${f.luchador1}</label><label><input type="radio" name="admin_winner_${f.id}" value="${f.luchador2}" ${resultadoGuardado.ganador_real === f.luchador2 ? 'checked' : ''}/> ${f.luchador2}</label>${extraFields}</div>`;
    });
  }

  async function saveResults() {
    const resultsToUpsert = [];
    if (peleasDelEvento.length === 0) {
        const { data: peleas } = await supabaseClient.from('peleas').select('*').eq('evento_id', currentEvent.id);
        peleasDelEvento = peleas || [];
    }

    for (const pelea of peleasDelEvento) {
        const ganador = document.querySelector(`input[name='admin_winner_${pelea.id}']:checked`);
        if (ganador) {
            let metodo = null;
            let round = null;
            if (pelea.tipo === 'Main Card') {
                const metodoElem = document.getElementById(`admin_method_${pelea.id}`);
                if (metodoElem) metodo = metodoElem.value;
            }
            if (pelea.es_evento_principal) {
                const roundElem = document.getElementById(`admin_round_${pelea.id}`);
                if (roundElem) round = roundElem.value;
            }
            resultsToUpsert.push({ pelea_id: pelea.id, ganador_real: ganador.value, metodo_real: metodo, round_real: round });
        }
    }

    if (resultsToUpsert.length === 0) return alert("No se ha seleccionado ning√∫n resultado para guardar.");
    
    // Para que 'upsert' funcione, 'pelea_id' debe ser una llave √∫nica en la tabla 'resultados'.
    // Ve a Supabase -> Table Editor -> resultados -> y aseg√∫rate de que 'pelea_id' tiene el modificador 'isUnique'.
    const { error } = await supabaseClient.from('resultados').upsert(resultsToUpsert, { onConflict: 'pelea_id' });
    if (error) {
        console.error("Error al guardar resultados:", error);
        return alert("Hubo un error al guardar los resultados: " + error.message);
    }
    alert("¬°Resultados guardados/actualizados con √©xito!");
  }
  
  // A√ëADE ESTA NUEVA FUNCI√ìN A TU SCRIPT
// REEMPLAZA TU FUNCI√ìN 'procesarLogros' CON ESTA
// En index.html, reemplaza esta funci√≥n
async function procesarLogros() {
    if (!currentEvent || !currentEvent.id) {
        return alert("No hay un evento seleccionado.");
    }

    const confirmacion = confirm("¬øEst√°s seguro de que quieres procesar los puntos y logros para este evento? Esta acci√≥n es definitiva.");
    if (!confirmacion) {
        return;
    }

    alert("Procesando... Esto puede tardar un momento.");

    const { data, error } = await supabaseClient.rpc('repartir_logros_evento', { 
        evento_id_param: currentEvent.id 
    });

    if (error) {
        console.error("Error al procesar logros:", error);
        return alert("Hubo un error al procesar los logros. Revisa la consola para m√°s detalles.");
    }

    // ¬°CAMBIO CLAVE! Mostramos el reporte completo que nos devuelve la base de datos.
    alert("--- Reporte del Motor de Logros ---\n\n" + data);
    console.log(data);
}
</script>

</body>
</html>