<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil</title>

    <nav>
        <a href="index.html">🏠 Inicio</a>
        <a href="stats.html">📊 Estadísticas</a>
        <a href="historial.html">📁 Historial</a>
    </nav>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a1a1a;
            color: #f2f2f2;
            margin: 0;
            padding: 20px;
        }

        /* Estilos de Navegación */
        nav {
            background: #111; padding: 15px 5px; text-align: center;
            border-bottom: 2px solid #DAA520; display: flex;
            justify-content: center; align-items: center;
            margin: -20px -20px 20px -20px;
        }
        nav a {
            font-family: 'Anton', sans-serif; color: white; margin: 0 15px;
            text-decoration: none; font-size: 1.2em; letter-spacing: 1px;
            transition: color 0.3s; flex-shrink: 0; 
        }
        nav a:hover { color: #DAA520; }
        @media (max-width: 700px) {
            nav { justify-content: space-around; }
            nav a { font-size: 1em; margin: 0 5px; letter-spacing: normal; }
        }

        /* Estilos de Títulos y Contenedores */
        h1, h2, h3 {
            font-family: 'Anton', sans-serif; text-transform: uppercase;
            letter-spacing: 1.5px; text-align: center; color: #DAA520;
        }
        h1 { font-size: 3em; margin-bottom: 40px; }
        h2 { font-size: 2em; margin-top: 40px; }
        h3 { font-size: 1.5em; color: #f2f2f2; }

        .profile-box {
            background: #2b2b2b; padding: 30px; max-width: 800px;
            margin: 20px auto; border-radius: 8px;
            border: 1px solid #444; border-top: 4px solid #DAA520;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .profile-info p {
            font-size: 1.1em; line-height: 1.6; border-bottom: 1px solid #444;
            padding-bottom: 10px; margin-top: 0; margin-bottom: 10px;
            display: flex; justify-content: space-between; flex-wrap: wrap;
        }
        .profile-info strong { color: #ccc; }
        .profile-info span { text-align: right; font-weight: bold; color: #fff; }

        .charts-container { 
            display: flex; 
            gap: 20px; 
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .chart-box {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            border: 1px solid #444; 
            border-radius: 8px; 
            background-color: #1f1f1f;
        }
        .chart-box h3 { text-align: center; }

        .loader {
            border: 6px solid #f3f3f3; border-top: 6px solid #DAA520;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin: 40px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- NUEVO: Ajustes para Móviles --- */
        @media (max-width: 700px) {
            body {
                padding: 10px; /* Menos espacio a los lados */
            }
            .profile-box {
                padding: 15px; /* Menos espacio dentro de la caja principal */
            }
            h1 { font-size: 2.2em; margin-bottom: 20px; }
            h2 { font-size: 1.6em; }
            h3 { font-size: 1.2em; }
            .profile-info p { font-size: 1em; }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Mi Perfil</h1>
    
    <div id="loading-message" class="loader"></div>

    <div id="profile-content" class="profile-box" style="display:none;">
        <h2>Información de la Cuenta</h2>
        <div id="account-info" class="profile-info"></div>
        
        <h2>Estadísticas Detalladas</h2>
        <div id="detailed-stats" class="profile-info"></div>

        <h2>Visualizaciones</h2>
        <div class="charts-container">
            <div class="chart-box">
                <h3>Estilo de Predicción</h3>
                <canvas id="predictionStyleChart"></canvas>
            </div>
            <div class="chart-box">
                <h3>Rendimiento por Evento</h3>
                <canvas id="eventPerformanceChart"></canvas>
            </div>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://dvpckpkgiwicifweiupo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2cGNrcGtnaXdpY2lmd2VpdXBvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzAzMzgsImV4cCI6MjA3MDA0NjMzOH0.37X7ZZ9cNDUlplHSSGrypxhmAKXpHUyFdrq9nJOdhbw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
            window.location.href = 'index.html';
            return;
        }
        await cargarPerfil(session.user);
    });

    async function cargarPerfil(user) {
        const [prediccionesRes, resultadosRes, eventosRes] = await Promise.all([
            supabaseClient.from('predicciones').select(`*, peleas(*)`).eq('usuario_id', user.id),
            supabaseClient.from('resultados').select(`*`),
            supabaseClient.from('eventos').select('*')
        ]);
        
        const { data: predicciones, error: predError } = prediccionesRes;
        const { data: resultados, error: resError } = resultadosRes;
        const { data: eventos, error: eventosError } = eventosRes;
        
        if (predError || resError || eventosError) {
            document.getElementById('loading-message').outerHTML = "<h1>Error al cargar tus datos.</h1>";
            return console.error(predError || resError || eventosError);
        }
        
        let totalPuntos = 0, totalAciertos = 0, totalPredicciones = predicciones.length, aciertosMetodo = 0, aciertosRound = 0, rachaActual = 0, rachaMaxima = 0;
        const metodoCounts = { 'KO': 0, 'Submisión': 0, 'Decisión': 0 };
        const puntosPorEvento = {};
        const peleadorStats = {};
        predicciones.sort((a, b) => a.pelea_id - b.pelea_id);
        
        for (const pred of predicciones) {
            if (pred.metodo_elegido) metodoCounts[pred.metodo_elegido]++;
            const ganadorElegido = pred.ganador_elegido;
            if (!peleadorStats[ganadorElegido]) peleadorStats[ganadorElegido] = { picks: 0, wins: 0 };
            peleadorStats[ganadorElegido].picks++;
            
            const resultadoReal = resultados.find(r => r.pelea_id === pred.pelea_id);
            if (resultadoReal) {
                const puntosGanados = calcularPuntos(pred, resultadoReal, eventos);
                if (resultadoReal.ganador_real === pred.ganador_elegido) { 
                    totalAciertos++; 
                    rachaActual++; 
                    peleadorStats[ganadorElegido].wins++; 
                    if (pred.metodo_elegido && pred.metodo_elegido === resultadoReal.metodo_real) {
                        aciertosMetodo++; 
                    }
                    if (pred.peleas.es_evento_principal && (String(pred.round_elegido) === String(resultadoReal.round_real) || (pred.round_elegido === 'Decision' && resultadoReal.metodo_real === 'Decisión'))) {
                        aciertosRound++;
                    }
                } else { 
                    rachaMaxima = Math.max(rachaMaxima, rachaActual); 
                    rachaActual = 0; 
                }
                totalPuntos += puntosGanados;
                const eventoId = pred.peleas.evento_id;
                puntosPorEvento[eventoId] = (puntosPorEvento[eventoId] || 0) + puntosGanados;
            }
        }
        rachaMaxima = Math.max(rachaMaxima, rachaActual);
        
        const accountContainer = document.getElementById('account-info');
        accountContainer.innerHTML = `
            <p><strong>Usuario:</strong> <span>${user.user_metadata.username || 'No definido'}</span></p>
            <p><strong>Email:</strong> <span>${user.email}</span></p>`;

        const porcentaje = totalPredicciones > 0 ? ((totalAciertos / totalPredicciones) * 100).toFixed(1) : 0;
        const metodoFavorito = Object.keys(metodoCounts).reduce((a, b) => metodoCounts[a] > metodoCounts[b] ? a : b, 'N/A');
        const mejorPuntuacion = Math.max(0, ...Object.values(puntosPorEvento));
        let textoPeleadorFavorito = "N/A";
        if (Object.keys(peleadorStats).length > 0) {
            const nombrePeleadorFavorito = Object.keys(peleadorStats).reduce((a, b) => peleadorStats[a].picks > peleadorStats[b].picks ? a : b);
            const statsFavorito = peleadorStats[nombrePeleadorFavorito];
            const winRateFavorito = statsFavorito.picks > 0 ? ((statsFavorito.wins / statsFavorito.picks) * 100).toFixed(1) : 0;
            textoPeleadorFavorito = `${nombrePeleadorFavorito} (${statsFavorito.picks} veces, ${winRateFavorito}% acierto)`;
        }
        
        const statsContainer = document.getElementById('detailed-stats');
        statsContainer.innerHTML = `
            <p><strong>Puntos Totales:</strong> <span>${totalPuntos}</span></p>
            <p><strong>Aciertos Globales:</strong> <span>${totalAciertos} de ${totalPredicciones} (${porcentaje}%)</span></p>
            <hr style="border-color: #444;">
            <p><strong>Estilo de Predicción:</strong> <span>${metodoFavorito}</span></p>
            <p><strong>Peleador de la Casa:</strong> <span>${textoPeleadorFavorito}</span></p>
            <hr style="border-color: #444;">
            <p><strong>Aciertos de Método Exacto:</strong> <span>${aciertosMetodo}</span></p>
            <p><strong>Aciertos de Round Principal:</strong> <span>${aciertosRound}</span></p>
            <hr style="border-color: #444;">
            <p><strong>Mejor Puntuación en un Evento:</strong> <span>${mejorPuntuacion} puntos</span></p>
            <p><strong>Mejor Racha de Aciertos:</strong> <span>${rachaMaxima} peleas</span></p>`;

        const chartFontColor = '#f2f2f2';
        Chart.defaults.color = chartFontColor;

        new Chart(document.getElementById('predictionStyleChart'),{type:'pie',data:{labels:['KO/TKO','Submisión','Decisión'],datasets:[{data:[metodoCounts['KO'],metodoCounts['Submisión'],metodoCounts['Decisión']],backgroundColor:['#d9534f','#5bc0de','#f0ad4e']}]},options:{responsive:true, maintainAspectRatio: true}});
        
        const eventosLabels = Object.keys(puntosPorEvento).map((id, index) => `#${index + 1}`);
        new Chart(document.getElementById('eventPerformanceChart'),{type:'bar',data:{labels:eventosLabels,datasets:[{label:'Puntos Conseguidos',data:Object.values(puntosPorEvento),backgroundColor:'#5cb85c'}]},options:{responsive:true,scales:{y:{ticks:{color:chartFontColor}},x:{ticks:{color:chartFontColor}}}}});

        document.getElementById('loading-message').style.display = 'none';
        document.getElementById('profile-content').style.display = 'block';
    }

    function calcularPuntos(prediccion, resultado, eventos) {
        let puntos = 0;
        const peleaInfo = prediccion.peleas;
        if (!resultado || !peleaInfo) return 0;
        const eventoDeLaPelea = eventos.find(e => e.id === peleaInfo.evento_id);
        if (!eventoDeLaPelea) return 0;
        if (resultado.ganador_real === prediccion.ganador_elegido) {
            puntos += peleaInfo.tipo === 'Preliminar' ? 1 : 2;
            if (peleaInfo.tipo === 'Main Card' && prediccion.metodo_elegido === resultado.metodo_real) {
                puntos += 1;
            }
            if (peleaInfo.es_evento_principal && (String(resultado.round_real) === String(prediccion.round_elegido) || (prediccion.round_elegido === 'Decision' && resultado.metodo_real === 'Decisión'))) {
                puntos += eventoDeLaPelea.puntos_extra_round;
            }
        }
        return puntos;
    }
</script>

</body>
</html>
