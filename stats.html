<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estadísticas Globales UFC</title>

  <nav style="background:#111; padding:10px; text-align:center;">
    <a href="index.html" style="color:white; margin:0 15px;">🏠 Inicio</a>
    <a href="historial.html" style="color:white; margin:0 15px;">📁 Historial</a>
    <a href="perfil.html" style="color:white; margin:0 15px;">👤 Mi Perfil</a>
  </nav>

  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 20px; }
    h1, h2 { text-align: center; }
    .table-box { background: #fff; padding: 20px; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 800px; margin: 20px auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #eaeaea; }
    #loading-message { text-align: center; font-size: 1.2em; padding: 40px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Estadísticas Globales de Usuarios</h1>
  
  <div id="loading-message">Cargando estadísticas...</div>

  <div id="stats-content" style="display:none;">
    <div class="table-box">
      <h2>🏆 Ranking de Puntos</h2>
      <table id="tabla-puntos">
        <thead><tr><th>#</th><th>Usuario</th><th>Puntos</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="table-box">
      <h2>🎯 Peleas Acertadas</h2>
      <table id="tabla-aciertos">
        <thead><tr><th>#</th><th>Usuario</th><th>Aciertos</th><th>Total Predicciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="table-box">
      <h2>📊 Porcentaje de Acierto</h2>
      <table id="tabla-porcentaje">
        <thead><tr><th>#</th><th>Usuario</th><th>% Acierto</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
    const SUPABASE_URL = 'https://dvpckpkgiwicifweiupo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2cGNrcGtnaXdpY2lmd2VpdXBvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzAzMzgsImV4cCI6MjA3MDA0NjMzOH0.37X7ZZ9cNDUlplHSSGrypxhmAKXpHUyFdrq9nJOdhbw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
            window.location.href = 'index.html';
            return;
        }
        cargarEstadisticas();
    });

    async function cargarEstadisticas() {
        // --- CONSULTAS SIMPLIFICADAS ---
        const { data: predicciones, error: predError } = await supabaseClient.from('predicciones').select(`*, peleas(*), profiles(username)`);
        const { data: resultados, error: resError } = await supabaseClient.from('resultados').select(`*`);
        const { data: eventos, error: eveError } = await supabaseClient.from('eventos').select('*');

        if (predError || resError || eveError) {
            console.error("Error obteniendo datos:", predError || resError || eveError);
            document.getElementById('loading-message').innerText = "Error al cargar los datos. Revisa la consola.";
            return;
        }

        const stats = {};
        for (const pred of predicciones) {
            const userId = pred.usuario_id;
            const username = pred.profiles ? pred.profiles.username : 'Usuario Desconocido';
            if (!stats[userId]) {
                stats[userId] = { username: username, puntos: 0, aciertos: 0, total: 0 };
            }
            stats[userId].total++;
            const resultadoReal = resultados.find(r => r.pelea_id === pred.pelea_id);
            if (resultadoReal) {
                // Pasamos la lista de eventos a la función de cálculo
                const puntosGanados = calcularPuntos(pred, resultadoReal, eventos);
                if (puntosGanados > 0) stats[userId].aciertos++;
                stats[userId].puntos += puntosGanados;
            }
        }
        
        // El resto de la lógica para mostrar las tablas no cambia...
        const statsArray = Object.values(stats);
        statsArray.sort((a, b) => b.puntos - a.puntos);
        const puntosBody = document.querySelector("#tabla-puntos tbody");
        puntosBody.innerHTML = '';
        statsArray.forEach((s, index) => {
            puntosBody.innerHTML += `<tr><td>${index + 1}</td><td>${s.username}</td><td>${s.puntos}</td></tr>`;
        });
        statsArray.sort((a, b) => b.aciertos - a.aciertos);
        const aciertosBody = document.querySelector("#tabla-aciertos tbody");
        aciertosBody.innerHTML = '';
        statsArray.forEach((s, index) => {
            aciertosBody.innerHTML += `<tr><td>${index + 1}</td><td>${s.username}</td><td>${s.aciertos}</td><td>${s.total}</td></tr>`;
        });
        statsArray.forEach(s => s.porcentaje = s.total > 0 ? ((s.aciertos / s.total) * 100) : 0);
        statsArray.sort((a, b) => b.porcentaje - a.porcentaje);
        const porcentajeBody = document.querySelector("#tabla-porcentaje tbody");
        porcentajeBody.innerHTML = '';
        statsArray.forEach((s, index) => {
            porcentajeBody.innerHTML += `<tr><td>${index + 1}</td><td>${s.username}</td><td>${s.porcentaje.toFixed(1)}%</td></tr>`;
        });
        document.getElementById('loading-message').style.display = 'none';
        document.getElementById('stats-content').style.display = 'block';
    }

    // REEMPLAZA ESTA FUNCIÓN EN AMBOS ARCHIVOS: perfil.html y stats.html

// En STATS.HTML, reemplaza solo esta función
function calcularPuntos(prediccion, resultado, eventos) {
    let puntos = 0;
    const peleaInfo = prediccion.peleas;
    if (!resultado || !peleaInfo) return 0;
    
    const eventoDeLaPelea = eventos.find(e => e.id === peleaInfo.evento_id);
    if (!eventoDeLaPelea) return 0;

    if (resultado.ganador_real === prediccion.ganador_elegido) {
        if (peleaInfo.tipo === 'Preliminar') {
            puntos += 1;
        } else if (peleaInfo.tipo === 'Main Card') {
            puntos += 2;
            if (prediccion.metodo_elegido && resultado.metodo_real && prediccion.metodo_elegido === resultado.metodo_real) {
                puntos += 1;
            }
        }
        if (peleaInfo.es_evento_principal) {
            if (String(resultado.round_real) === String(prediccion.round_elegido) || (prediccion.round_elegido === 'Decision' && resultado.metodo_real === 'Decisión')) {
                puntos += eventoDeLaPelea.puntos_extra_round;
            }
        }
    }
    return puntos;
}
</script>

</body>
</html>

</body>
</html>




