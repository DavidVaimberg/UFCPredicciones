<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estad铆sticas Globales UFC</title>

  <nav>
    <a href="index.html"> Inicio</a>
    <a href="historial.html"> Historial</a>
    <a href="perfil.html"> Mi Perfil</a>
  </nav>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap');
    body { font-family: 'Roboto', sans-serif; background-color: #1a1a1a; color: #f2f2f2; margin: 0; padding: 20px; }
    
    /* --- Estilos de Navegaci贸n --- */
    nav { background: #111; padding: 15px 5px; text-align: center; border-bottom: 2px solid #DAA520; display: flex; justify-content: center; align-items: center; margin: -20px -20px 20px -20px; }
    nav a { font-family: 'Anton', sans-serif; color: white; margin: 0 15px; text-decoration: none; font-size: 1.2em; letter-spacing: 1px; transition: color 0.3s; }
    nav a:hover { color: #DAA520; }
    
    h1, h2 { text-align: center; font-family: 'Anton', sans-serif; text-transform: uppercase; letter-spacing: 1.5px; color: #DAA520; }
    h1 { font-size: 3em; margin-bottom: 30px; }
    
    .table-box { background: #2b2b2b; padding: 20px; margin-bottom: 30px; border-radius: 10px; border-top: 4px solid #DAA520; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 900px; margin-left: auto; margin-right: auto; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border-bottom: 1px solid #444; padding: 12px 15px; text-align: center; color: #ddd; }
    th { background-color: #1f1f1f; color: #DAA520; font-family: 'Anton', sans-serif; letter-spacing: 1px; font-size: 1.1em; }
    tr:hover { background-color: #3c3c3c; }
    
    #loading-message { text-align: center; font-size: 1.2em; padding: 40px; color: #888; }
    .loader { border: 5px solid #333; border-top: 5px solid #DAA520; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Estad铆sticas Globales</h1>
  
  <div id="loading-message">
    <div class="loader"></div>
    Cargando datos...
  </div>

  <div id="stats-content" style="display:none;">
    <div class="table-box">
      <h2> Ranking de Puntos</h2>
      <table id="tabla-puntos">
        <thead><tr><th>#</th><th>Usuario</th><th>Puntos</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="table-box">
      <h2> Ranking de Precisi贸n</h2>
      <table id="tabla-aciertos">
        <thead><tr><th>#</th><th>Usuario</th><th>Aciertos</th><th>Total</th><th>Precisi贸n (%)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
    const SUPABASE_URL = 'https://dvpckpkgiwicifweiupo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2cGNrcGtnaXdpY2lmd2VpdXBvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzAzMzgsImV4cCI6MjA3MDA0NjMzOH0.37X7ZZ9cNDUlplHSSGrypxhmAKXpHUyFdrq9nJOdhbw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
            window.location.href = 'index.html';
            return;
        }
        cargarEstadisticas();
    });

    async function cargarEstadisticas() {
        console.log("Iniciando carga de estad铆sticas...");

        // 1. PEDIMOS LOS DATOS POR SEPARADO (ESTRATEGIA SEGURA)
        // Esto evita que la base de datos oculte filas si falla una uni贸n compleja
        const { data: predicciones, error: predError } = await supabaseClient.from('predicciones').select('*');
        const { data: resultados, error: resError } = await supabaseClient.from('resultados').select('*');
        const { data: peleas, error: peleasError } = await supabaseClient.from('peleas').select('*');
        const { data: eventos, error: eventosError } = await supabaseClient.from('eventos').select('*');
        const { data: profiles, error: profilesError } = await supabaseClient.from('profiles').select('*');

        if (predError || resError || peleasError || eventosError || profilesError) {
            console.error("Error cargando datos:", predError || resError || peleasError || eventosError || profilesError);
            document.getElementById('loading-message').innerHTML = "<p style='color:red'>Error al cargar datos. Revisa la consola.</p>";
            return;
        }

        console.log(`Datos cargados: ${predicciones.length} predicciones.`);

        // 2. PROCESAMIENTO Y UNIN EN JAVASCRIPT
        const stats = {};

        // Inicializar stats para todos los perfiles encontrados (para que aparezcan aunque tengan 0 puntos)
        profiles.forEach(p => {
            stats[p.id] = { username: p.username, puntos: 0, aciertos: 0, total: 0 };
        });

        for (const pred of predicciones) {
            // Buscamos manualmente los datos relacionados
            const usuario = stats[pred.usuario_id];
            const pelea = peleas.find(p => p.id === pred.pelea_id);
            const resultado = resultados.find(r => r.pelea_id === pred.pelea_id);
            
            // Si falta alg煤n dato clave (ej: usuario borrado), saltamos esta predicci贸n
            if (!usuario || !pelea) continue;

            // Encontramos el evento para saber las reglas de puntos
            const evento = eventos.find(e => e.id === pelea.evento_id);
            
            // Aumentamos el contador de predicciones totales del usuario
            usuario.total++;

            if (resultado) {
                const puntosGanados = calcularPuntos(pred, resultado, pelea, evento);
                if (puntosGanados > 0) {
                    usuario.aciertos++;
                }
                usuario.puntos += puntosGanados;
            }
        }

        // 3. MOSTRAR RESULTADOS
        const statsArray = Object.values(stats).filter(s => s.total > 0); // Opcional: ocultar usuarios sin participaci贸n

        // Ranking de Puntos
        statsArray.sort((a, b) => b.puntos - a.puntos);
        const puntosBody = document.querySelector("#tabla-puntos tbody");
        puntosBody.innerHTML = '';
        statsArray.forEach((s, index) => {
            let medal = '';
            if (index === 0) medal = '';
            if (index === 1) medal = '';
            if (index === 2) medal = '';
            puntosBody.innerHTML += `<tr>
                <td>${medal} ${index + 1}</td>
                <td style="font-weight:bold; color:#fff;">${s.username}</td>
                <td style="color:#DAA520; font-weight:bold;">${s.puntos}</td>
            </tr>`;
        });

        // Ranking de Precisi贸n
        // Calculamos porcentaje antes de ordenar
        statsArray.forEach(s => s.porcentaje = s.total > 0 ? ((s.aciertos / s.total) * 100) : 0);
        
        // Ordenar por Porcentaje (y luego por cantidad de aciertos para desempate)
        statsArray.sort((a, b) => {
            if (b.porcentaje !== a.porcentaje) return b.porcentaje - a.porcentaje;
            return b.aciertos - a.aciertos;
        });

        const aciertosBody = document.querySelector("#tabla-aciertos tbody");
        aciertosBody.innerHTML = '';
        statsArray.forEach((s, index) => {
            aciertosBody.innerHTML += `<tr>
                <td>${index + 1}</td>
                <td style="font-weight:bold;">${s.username}</td>
                <td style="color:#28a745;">${s.aciertos}</td>
                <td>${s.total}</td>
                <td style="font-weight:bold;">${s.porcentaje.toFixed(1)}%</td>
            </tr>`;
        });

        document.getElementById('loading-message').style.display = 'none';
        document.getElementById('stats-content').style.display = 'block';
    }

    // Funci贸n de c谩lculo (Adaptada para recibir objetos separados)
    function calcularPuntos(prediccion, resultado, pelea, evento) {
        let puntos = 0;
        
        // Validaciones de seguridad
        if (!resultado || !pelea) return 0;
        
        // Si el evento no se encuentra, asumimos valores por defecto (x1 y 1 punto extra)
        const multiplicador = evento ? evento.multiplicador_puntos : 1;
        const puntosExtraRound = evento ? evento.puntos_extra_round : 1;

        if (resultado.ganador_real === prediccion.ganador_elegido) {
            if (pelea.tipo === 'Preliminar') {
                puntos += (1 * multiplicador);
            } else if (pelea.tipo === 'Main Card') {
                puntos += (2 * multiplicador);
                // Bonus m茅todo (no se multiplica)
                if (prediccion.metodo_elegido && resultado.metodo_real && prediccion.metodo_elegido === resultado.metodo_real) {
                    puntos += 1;
                }
            }
            // Bonus round (no se multiplica)
            if (pelea.es_evento_principal) {
                if (String(resultado.round_real) === String(prediccion.round_elegido) || (prediccion.round_elegido === 'Decision' && resultado.metodo_real === 'Decisi贸n')) {
                    puntos += puntosExtraRound;
                }
            }
        }
        return puntos;
    }
</script>

</body>
</html>


